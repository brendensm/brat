#!/bin/bash

# brat setup script

set -e

BRAT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "brat setup"
echo "==========="
echo ""

# Detect OS
detect_os() {
  case "$(uname -s)" in
    Darwin*)  echo "macos" ;;
    Linux*)
      if grep -qi microsoft /proc/version 2>/dev/null; then
        echo "wsl"
      else
        echo "linux"
      fi
      ;;
    MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
    *) echo "unknown" ;;
  esac
}

OS=$(detect_os)
echo "Detected OS: $OS"
echo ""

# Check dependencies
check_dep() {
  if command -v "$1" &>/dev/null; then
    echo "  ✓ $1"
    return 0
  else
    echo "  ✗ $1 (missing)"
    return 1
  fi
}

echo "Checking dependencies..."
missing=()
check_dep "curl" || missing+=("curl")
check_dep "jq" || missing+=("jq")
check_dep "fzf" || missing+=("fzf")
check_dep "R" || missing+=("R")
echo ""

# Suggest installation for missing deps
if [[ ${#missing[@]} -gt 0 ]]; then
  echo "Missing dependencies: ${missing[*]}"
  echo ""
  echo "Install them with:"

  case "$OS" in
    macos)
      echo "  brew install ${missing[*]}"
      ;;
    linux|wsl)
      echo "  # For jq, curl, fzf:"
      echo "  sudo apt install ${missing[*]}"
      echo "  # For R:"
      echo "  sudo apt install r-base"
      ;;
    windows)
      echo "  # Consider using WSL for best compatibility"
      echo "  # Or install via scoop/chocolatey:"
      echo "  scoop install ${missing[*]}"
      ;;
  esac
  echo ""

  read -p "Continue anyway? [y/N] " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Make scripts executable
echo "Making scripts executable..."
chmod +x "$BRAT_DIR/brat"
chmod +x "$BRAT_DIR/project"
chmod +x "$BRAT_DIR/install"
chmod +x "$BRAT_DIR/tt"
chmod +x "$BRAT_DIR/blog"
echo "  ✓ Done"
echo ""

# Detect shell config file
detect_shell_config() {
  if [[ -n "$ZSH_VERSION" ]] || [[ "$SHELL" == */zsh ]]; then
    echo "$HOME/.zshrc"
  elif [[ -n "$BASH_VERSION" ]] || [[ "$SHELL" == */bash ]]; then
    if [[ -f "$HOME/.bash_profile" ]]; then
      echo "$HOME/.bash_profile"
    else
      echo "$HOME/.bashrc"
    fi
  else
    echo "$HOME/.profile"
  fi
}

SHELL_CONFIG=$(detect_shell_config)
EXPORT_LINE="export PATH=\"$BRAT_DIR:\$PATH\""

# Check if already in PATH
if [[ ":$PATH:" == *":$BRAT_DIR:"* ]]; then
  echo "brat is already in your PATH"
elif grep -Fq "$BRAT_DIR" "$SHELL_CONFIG" 2>/dev/null; then
  echo "PATH entry already exists in $SHELL_CONFIG"
  echo "Restart your shell or run: source $SHELL_CONFIG"
else
  echo "Add brat to PATH?"
  echo "  This will add the following line to $SHELL_CONFIG:"
  echo "  $EXPORT_LINE"
  echo ""
  read -p "Add to PATH? [Y/n] " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    echo "" >> "$SHELL_CONFIG"
    echo "# brat - bash-based r-adjacent tools" >> "$SHELL_CONFIG"
    echo "$EXPORT_LINE" >> "$SHELL_CONFIG"
    echo "  ✓ Added to $SHELL_CONFIG"
    echo ""
    echo "Run this to use brat now:"
    echo "  source $SHELL_CONFIG"
  else
    echo "Skipped. You can manually add brat to your PATH:"
    echo "  $EXPORT_LINE"
  fi
fi

echo ""
brat logo
echo "Setup complete! Run 'brat help' to get started."
